
# Script to automate wrapping Irrlicht for BlitzMax

# copy header tree
# comment out erroneous declarations
#   references to private classes (CIndexBuffer.h, CVertexBuffer.h)
#   PACK_STRUCT / irrpack.h
#   IGPUProgrammingServices.h - remove defaults causing ambiguous calls
# redeclare some structs as classes so they appear in the CLOS interface
#   IVertexManipulator (needed for inheritance hierarchy)

# automatically scan for template typedefs to build %template list
	pcregrep -h '^[ \t]*typedef\s.*?<.*?;' include.SWIG/* > template-typedefs1.i
# comment XML*, Node, position2d, tQ3EntityList, stringc, stringw
	for t in tQ3EntityList IXMLReader IXMLReaderUTF8 Node stringc stringw char16 char32 IrrXMLReader IrrXMLReader16 IrrXMLReader32 position2df position2di ; do
		sed -i ".irrlicht.bak" -e "s/^.*\(typedef[[:blank:]]*[^;]*>[[:blank:]]*$t;\)/\/\/\1/g" template-typedefs1.i
	done
	cp template-typedefs1.i template-typedefs2.i
	sed -i ".irrlicht.bak" -e 's/^[[:blank:]]*typedef[[:blank:]]*\([^;]*\)>[[:blank:]]*\([^;]*\);/TYPEDEF(\2, \1>)/g' template-typedefs1.i
	sed -i ".irrlicht.bak" -e 's/^[[:blank:]]*typedef[[:blank:]]*\([^;]*\)>[[:blank:]]*\([^;]*\);/%template(\2) \1>;/g' template-typedefs2.i

# run swig
	swig -c++ -includeall -ignoremissing -fvirtual -cffi -noswig-lisp irrlicht.i
# delete include.SWIG
	rm -rf include.SWIG/

# build wrapper library
	g++ -Os -m32 -c -w irrlicht_wrap.cxx

# correct .lisp syntax (remove #. , [] -> aRef)
	sed -i ".irrlicht.bak" -e 's/#\.//g' irrlicht.lisp
	sed -i ".irrlicht.bak" -e 's/\[\]/aRef/g' irrlicht-clos.lisp

# run cffi2bmx
	echo "(irrlicht libIrrlicht.a)" | gsi -e '(load "~~/lib/syntax-case")' cffi-to-bmx.scm

# correct include path and namespaces for irrlicht.gen-enums.cpp
g++ irrlicht.gen-enums.cpp -o irrlicht.gen-enums && ./irrlicht.gen-enums > irrlicht.extra-enums.bmx

# fill in cvar wrapper functions with irrlicht.cvar-wrapper.cpp
g++ -m32 -c -w irrlicht.cvar-wrapper2.cpp -o irrlicht.cvar-wrapper.o

# manually choose overload names

# build irrlicht
#   build lib target in Xcode "for running"
#   sed out duplicate symbols in libpng/pngerror.c
#   comment out [NSApp finishLaunching]; to allow GUI build

# make final manual corrections to BMX code in response to errors
#   comment out duplicate identifiers, Pi, etc.
'Const EGUIET_FORCE_32_BIT
'Const EGST_COUNT
'Function PI
#   fix these with a per-project sed script
#  Correct inheritance for multi-path classes where appropriate
#   ICameraSceneNode should extend ISceneNode by default

  for f in *.irrlicht.bak ; do rm "$f" ; done

# ready to use!


# Questions/issues:
#  - should enums be packaged in types rather than left at toplevel?
#  - how best to namespace functions and globals?
#  - should :pointer convert to Int instead of Byte Ptr?
#  - is it safe to eradicate duplicated overloads (esp. by name?)
#  - how best to rename overloads? by type or by arg name? (default to name, retry with type)

